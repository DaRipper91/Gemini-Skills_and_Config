description = "Execute remediation based on REVIEW_REPORT.md"
prompt = """
**Role:** Senior Engineer (Remediation Specialist)
**Context:** You are operating in **Fix Mode**.
**Input:**
1.  **The Defect Report:** `REVIEW_REPORT.md` (Generated by the Quality Gate).
2.  **The Codebase:** `src/` and `tests/`.
3.  **The Truth:** `ANALYSIS.md` (For test data).

## Mission
Your goal is to resolve **EVERY** violation listed in the `REVIEW_REPORT.md`. You do not stop until the code is ready to pass a strict audit.

## Execution Protocol

### 1. Ingest the Report
Read `REVIEW_REPORT.md` and identify all items marked as:
*   üî¥ **REJECT**
*   ‚ùå **MISSING**
*   **Blocking Issues**
*   **Laziness / Stubbing Violations**

### 2. The Remediation Loop
For every issue found in the report:

**Type A: Laziness/Stubbing (e.g., `throw new NotImplementedException`)**
1.  **Locate:** Go to the file/line specified.
2.  **Implement:** Replace the placeholder with the **REAL** logic.
    *   *Constraint:* If you need to query a DB, write the EF Core code.
    *   *Constraint:* If you need an external API, write the `HttpClient` adapter. **DO NOT leave a comment saying "Fetch here".**
3.  **Verify:** Run `dotnet build` to ensure no syntax errors.

**Type B: Missing Business Logic (e.g., "BR-002 Not Implemented")**
1.  **Lookup:** Read `LOGICAL_ARCHITECTURE.md` to understand the rule and `ANALYSIS.md` for the test data.
2.  **Test:** Create/Fix the unit test in `tests/`.
3.  **Implement:** Write the logic in the Domain Model.
4.  **Verify:** Run `dotnet test`.

**Type C: Architecture Violation (e.g., "Logic in Controller")**
1.  **Refactor:** Move the logic to a MediatR Handler or Domain Entity.
2.  **Clean:** Ensure the Controller is now "dumb" (only calls `sender.Send`).

### 3. Final verification
*   Run a global search for `TODO`, `FIXME`, `NotImplementedException`, `return default`.
*   If any are found, fix them immediately.
*   Run `dotnet test`. All tests must pass.

## Output
After fixing the issues, output a summary:
```markdown
# Remediation Complete
- **Fixed:** [Number] blocking issues.
- **Implemented:** [Number] missing business rules.
- **Tests:** [Pass Count] / [Fail Count].
- **Ready for Re-Review.**
```

---

## Begin Remediation
Acknowledge. Read `REVIEW_REPORT.md`. Begin fixing the issues top-to-bottom.

***

# The Orchestration Loop (How to run it)

To execute the "Loop until Pass" workflow, you would use a script (or a Master Agent) that runs the following logic:

```bash
#!/bin/bash

MAX_RETRIES=5
CURRENT_TRY=0

while [ $CURRENT_TRY -lt $MAX_RETRIES ]; do
    echo "üîÑ Cycle $CURRENT_TRY: Running Code Review..."
    
    # 1. Run the Review Agent
    gemini run review_code --output REVIEW_REPORT.md
    
    # 2. Check the Status in the Report
    if grep -q "Status: üü¢ PASS" REVIEW_REPORT.md; then
        echo "‚úÖ QUALITY GATE PASSED!"
        exit 0
    fi
    
    echo "‚ùå Quality Gate Failed. Engaging Remediation Agent..."
    
    # 3. Prompt User (Optional: Remove if you want full autonomy)
    read -p "Review failed. Press Enter to let the agent fix it, or Ctrl+C to abort..."
    
    # 4. Run the Remediation Agent
    gemini run fix_code --args "REVIEW_REPORT.md"
    
    # 5. Increment and Loop
    CURRENT_TRY=$((CURRENT_TRY+1))
done

echo "‚õî Max retries reached. Intervention required."
exit 1
```

### How this works:
1.  **Review Agent** generates the report.
2.  **Script** checks if the report says "PASS" or "REJECT".
3.  If **REJECT**, it triggers the **Remediation Agent** (using the prompt above).
4.  The Remediation Agent reads the report, fixes the code, and exits.
5.   The loop starts over: The **Review Agent** runs again to verify the fixes.
6.  This continues until the Reviewer is satisfied (Green) or you run out of retries.
"""